# スプリント6：CI/CD ハンズオン課題

## 背景

あなたは、とあるWebサービスを運営する企業で、インフラエンジニアとして働いています。

自社サービスとして運営している「おみくじAPI」について、運用を改善したいと考えています。
（Sprint3で作成したものと同様の内容です）

現在、アプリケーションの更新は手動でデプロイしており、以下の課題があります。
- デプロイ作業に時間がかかる
- 手動作業によるヒューマンエラーのリスクがある
- 開発チームがコードを更新してから本番反映までのリードタイムが長い

これらの課題を解決するため、**CI/CDパイプライン**を構築し、コードの変更が自動的にデプロイされる仕組みを実現したいと考えています。

あなたはインフラエンジニアとして、「おみくじAPI」に対するCI/CDパイプラインを構築する必要があります。

## 実施手順

1. まずは要件を実現するための設計として、AWS構成図を作成しましょう。
2. 構成図に従い、実際にAWSで環境構築してみましょう。
3. 構築が終わったら、動作確認をしていきましょう。

## 要件

### 要件1：ソースコードの管理
- 下記のリポジトリにおみくじAPIがあるため、ご自身のGitHubアカウントにForkして利用する
  - https://github.com/CloudTechOrg/sprint3-api
- Dockerfileはリポジトリに含まれている
- CI/CDパイプラインの実行に必要な設定ファイルは自身で作成する

### 要件2：CI/CDパイプラインの構築
- GitHubリポジトリへのプッシュをトリガーとして、自動的にパイプラインが実行される
- パイプラインでは以下の処理を自動化する
  1. ソースコードの取得
  2. コンテナイメージのビルド
  3. コンテナイメージをレジストリにプッシュ
  4. アプリケーションのデプロイ（コンテナの更新）

### 要件3：コンテナ実行基盤
- コンテナが動作する基盤はECS/Fargateとする
- 冗長化やオートスケーリングは不要（最小構成で可）
- ロードバランサーは使用しなくても可（パブリックIPで直接アクセスできれば良い）

## APIの使い方
- [こちら](https://github.com/CloudTechOrg/sprint6-api/blob/main/README.md)に、APIの操作方法が記載されています

## 構築チェックリスト

下記が実装されていることを確認してください。

### 要件1：ソースコードの管理
- リポジトリがご自身のGitHubアカウントにForkされていること
- CI/CDパイプラインの設定ファイルが作成されていること

### 要件2：CI/CDパイプラインの構築
- GitHubリポジトリへのプッシュをトリガーとして、パイプラインが自動的に実行されること
- ソースコードの取得が自動化されていること
- コンテナイメージのビルドが自動化されていること
- コンテナイメージがレジストリにプッシュされること
- アプリケーションのデプロイ（コンテナの更新）が自動化されていること

### 要件3：コンテナ実行基盤
- コンテナがECS/Fargateで動作していること

## 動作確認
- パイプラインを手動で実行し、アプリケーションがデプロイされること
    - 例：`curl http://<エンドポイント>/omikuji`
    - レスポンス例：`{"result": "大吉", "message": "すべてがうまくいく最高の運勢です！"}`
- GitHubリポジトリへのプッシュをトリガーとして、パイプラインが自動的に実行されること
- デプロイ完了後、変更が反映されていること

## 理解度の確認
この課題の理解度を確認するため、以下の内容を言語化してみましょう。

### 問題1：CI/CDのメリット
手動でのデプロイ作業と比較して、CI/CDパイプラインを導入することでどのようなメリットがあるか、具体的な利用シーンを交えて説明してください。

### 問題2：CI/CDパイプラインの構成要素
今回構築したCI/CDパイプラインについて、ソースコードの変更からデプロイ完了までの流れを、使用したAWSサービス名を交えて説明してください。

### 問題3：buildspec.ymlの役割
CodeBuildで使用するbuildspec.ymlファイルの役割について説明してください。また、buildspec.ymlに記述する主要なフェーズ（phases）とその目的についても説明してください。

### 問題4：デプロイ戦略
アプリケーションのデプロイ方法には、インプレースデプロイ、ローリングデプロイ、Blue/Greenデプロイなど複数の戦略があります。それぞれの特徴と、どのような要件に適しているか説明してください。

## ヒント
- AWSにはCI/CDパイプラインを構築するためのサービスが複数用意されています
- コンテナイメージのビルドには、ビルド用のサービスを利用すると便利です
- パイプラインの設定ファイル（buildspec.yml等）の書き方は、CloudTech講座やAWSの公式ドキュメントなどを参照してください
- GitHubとAWSを連携するための接続設定が必要です

## トラブルシューティング

### パイプラインが開始されない
- GitHubとの接続が正しく設定されているか確認してください
- 接続のステータスが「利用可能」になっているか確認してください
- トリガーとなるブランチ名が正しいか確認してください

### ビルドが失敗する
- CodeBuildのビルドログを確認してください
- buildspec.ymlの構文が正しいか確認してください
- CodeBuildのサービスロールにECRへのプッシュ権限があるか確認してください
- Dockerfileのパスが正しいか確認してください

### buildspec.ymlの基本構造
```yaml
version: 0.2

phases:
  pre_build:
    commands:
      # ECRへのログイン等
  build:
    commands:
      # Dockerイメージのビルド
  post_build:
    commands:
      # ECRへのプッシュ、imagedefinitions.jsonの作成等
artifacts:
  files:
    # デプロイに必要なファイル
```

### デプロイが失敗する
- CodePipelineのデプロイステージのエラーメッセージを確認してください
- imagedefinitions.jsonの形式が正しいか確認してください
- ECSサービスがCodePipelineからのデプロイを受け入れる設定になっているか確認してください

### imagedefinitions.jsonの形式
```json
[
  {
    "name": "<コンテナ名>",
    "imageUri": "<ECRイメージURI>"
  }
]
```

### ECSタスクが起動しない
- タスク定義の設定（CPU、メモリ、コンテナイメージURL）が正しいか確認してください
- ECRにイメージが正しくプッシュされているか確認してください
- タスク実行ロールにECRからのイメージプル権限があるか確認してください
- CloudWatch Logsでコンテナのエラーログを確認してください

### ECSタスクがコンテナイメージの取得に失敗する
- ECSタスクがプライベートサブネットに配置されている場合、NAT Gatewayが存在するか確認してください
- パブリックサブネットに配置する場合は、「パブリックIPの自動割り当て」が有効になっているか確認してください
