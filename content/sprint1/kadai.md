# スプリント1：ネットワークとサーバ ハンズオン課題

## 背景

あなたは、とあるWebサービスを運営する企業で、インフラエンジニアとして働いています。

この度、新しく自社サービスとして「BMI計算ツール」をリリースすることになりました。

すでにアプリケーション開発チームが、フロントエンドとバックエンド（API）の開発を完了しています。

あなたはインフラエンジニアとして、これらのアプリケーションが正常に動作するインフラ環境を構築する必要があります。

## 実施手順

1. まずは要件を実現するための設計として、AWS構成図を作成しましょう。
2. 構成図に従い、実際にAWSで環境構築してみましょう。
3. 構築が終わったら、動作確認をしていきましょう。

## プロジェクト体制

| 担当 | チーム | 役割・タスク |
| :--- | :--- | :--- |
| **開発担当** | 開発チーム | ・アプリケーション開発<br>・サーバ構築のシェルスクリプト作成 |
| **あなた** | インフラチーム | ・AWS構成図作成<br>・AWS環境構築 |
| **メンター** | 支援チーム | ・成果物のレビュー<br>・技術サポート (CloudTech Academy受講生のみ) |

## 要件

### 要件1：サーバ構成
- 2台のサーバにより構成される。それぞれ、Webサーバ、APIサーバとし、EC2インスタンスを2台用意して構成する。
- EC2インスタンスのAMIはAmazon Linux 2023を使用する。
- それぞれのサーバの初期構築は、別途提示されるシェルスクリプトをEC2のユーザデータにて実行することで行う。

#### APIサーバの構築方法
- [こちら](https://github.com/CloudTechOrg/sprint1-api/blob/main/userdata/api_userdata.sh)をuserdataで実行してください

#### Webサーバの構築方法
- [こちら](https://github.com/CloudTechOrg/sprint1-frontend/blob/main/userdata/web_userdata.sh)をuserdataで実行してください
- `API_SERVER_IP`にはAPIサーバのPrivate IPアドレスを設定してください

### 要件2：アクセス制御
- Webサーバはインターネットからの80ポート通信を許可する
- APIサーバはWebサーバからの8080ポート通信のみ許可する（インターネットからの通信は拒否）
- APIサーバは、ソフトウェアのインストールのために、アウトバウンド通信およびその戻りの通信のみ許可する

### 要件3：IPアドレスの固定化
* Webサーバは、インスタンス再起動によりパブリックIPアドレスが変更されないようにする（Elastic IPを使用）

## ヒント
- EC2のインスタンスタイプは `t2.micro` を使用すると、無料利用枠の対象となります。

## トラブルシューティング

### Webサーバにブラウザからアクセスできない
- セキュリティグループで80ポートが許可されているか確認してください
- WebサーバにパブリックIPアドレス（またはElastic IP）が割り当てられているか確認してください
- インターネットゲートウェイがVPCにアタッチされているか確認してください
- ルートテーブルにインターネットゲートウェイへのルート（0.0.0.0/0）が設定されているか確認してください

### 画面は表示されるが、BMI計算ができない
- WebサーバからAPIサーバへの通信が可能か確認してください（セキュリティグループ、ルートテーブル）
- userdataに設定したAPIサーバのIPアドレスが正しいか確認してください

### userdataの実行が成功したか確認したい
userdataが正常に実行されたかどうかは、EC2インスタンスにSSH接続してログを確認することで調査できます。

#### 1. SSH接続を許可する
トラブルシューティングのため、一時的にSSH接続を許可しましょう。
- **Webサーバ**: セキュリティグループでインターネットからの22ポート通信を許可する
- **APIサーバ**: セキュリティグループでWebサーバからの22ポート通信を許可する

#### 2. EC2インスタンスに接続する
- Webサーバには、パブリックIPアドレスを使用してSSH接続します
- APIサーバには、Webサーバを経由してSSH接続します（Webサーバに秘密鍵を配置する必要があります）

#### 3. ログを確認する
以下のコマンドでuserdataの実行ログを確認できます。
```bash
sudo cat /var/log/cloud-init-output.log
```
- ログの末尾に `finished` や `SUCCESS` と表示されていれば正常に完了しています
- エラーが発生している場合は、ログ内のエラーメッセージを確認してください