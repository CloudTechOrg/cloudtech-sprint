# スプリント1：ネットワークとサーバ ハンズオン課題

## 背景

あなたは、とあるWebサービスを運営する企業で、インフラエンジニアとして働いています。

この度、新しく自社サービスとして「BMI計算ツール」をリリースすることになりました。

すでにアプリケーション開発チームが、フロントエンドとバックエンド（API）の開発を完了しています。

あなたはインフラエンジニアとして、これらのアプリケーションが正常に動作するインフラ環境を構築する必要があります。

## 実施手順

1. まずは要件を実現するための設計として、AWS構成図を作成しましょう。
2. 構成図に従い、実際にAWSで環境構築してみましょう。
3. 構築が終わったら、動作確認をしていきましょう。

## 要件

### 要件1：サーバ構成
- 2台のサーバにより構成される。それぞれ、Webサーバ、APIサーバとし、EC2インスタンスを2台用意して構成する。
- EC2インスタンスのAMIはAmazon Linux 2023を使用する。
- それぞれのサーバの初期構築は、別途提示されるシェルスクリプトをEC2のユーザデータにて実行することで行う。

#### APIサーバの構築方法
- [こちら](https://github.com/CloudTechOrg/sprint1-api/blob/main/userdata/api_userdata.sh)をuserdataで実行してください

#### Webサーバの構築方法
- [こちら](https://github.com/CloudTechOrg/sprint1-frontend/blob/main/userdata/web_userdata.sh)をuserdataで実行してください
- `API_SERVER_IP`にはAPIサーバのPrivate IPアドレスを設定してください

### 要件2：アクセス制御
- Webサーバはインターネットからの80ポート通信を許可する
- APIサーバはWebサーバからの8080ポート通信のみ許可する（インターネットからの通信は拒否）
- APIサーバは、ソフトウェアのインストールのために、アウトバウンド通信およびその戻りの通信のみ許可する

### 要件3：IPアドレスの固定化
- Webサーバは、インスタンス再起動によりパブリックIPアドレスが変更されないようにする（Elastic IPを使用）

## 構築チェックリスト

下記が実装されていることを確認してください。

### 要件1：サーバ構成
- Webサーバが構築されていること
- APIサーバが構築されていること

### 要件2：アクセス制御
- Webサーバで、インターネット（0.0.0.0/0）からの80ポート通信が許可されていること
- APIサーバで、Webサーバからの8080ポート通信のみ許可されていること
- APIサーバで、インターネットからの直接アクセスが拒否されていること
- APIサーバで、アウトバウンド通信が許可されていること

### 要件3：IPアドレスの固定化
- WebサーバにElastic IPが割り当てられていること

## 動作確認
- WebサーバのパブリックIPアドレスにより、Webサイトが開かれること
    - 例：http://<IPアドレス>
- Webサイトで任意の身長と体重を入力し、「計算する」をクリックすると、該当のBMIとアドバイスが表示されること

## 理解度の確認
この課題の理解度を確認するため、以下の内容を言語化してみましょう。

### 問題1：クラウドアーキテクチャのメリット
サーバを構築する際、オンプレミスで構築することと比較して、クラウド（EC2）を使って構築する場合にいくつかのメリット・デメリットがあります。
これらについて、具体的な利用シーンを交えながらあなたの考えを考察してください。
なお、説明の際には「コスト」「スピード・俊敏性」「運用・保守」「セキュリティ」の観点を加えてください。

### 問題2：ネットワークの通信経路
今回構築したハンズオンの構成について、実際の通信の流れを考えてみましょう。ユーザがどのようにシステムにアクセス（リクエスト）し、どのようなサービスを経由してユーザにデータを返す（レスポンス）のかを考察してください。実際のAWSサービス名を交えながら回答してください。

### 問題3：AWSの責任範囲
AWSを利用する際、AWS側が責任を持つ範囲、ユーザが責任を持つ範囲に大きく分かれる「責任範囲」の考え方があります。AWS、ユーザはそれぞれどのような責任を持つべきか、あなたの考えを考察してみてください。

## ヒント
- EC2のインスタンスタイプは `t2.micro` を使用すると、無料利用枠の対象となります。

## トラブルシューティング

### Webサーバにブラウザからアクセスできない
- セキュリティグループで80ポートが許可されているか確認してください
- WebサーバにパブリックIPアドレス（またはElastic IP）が割り当てられているか確認してください
- インターネットゲートウェイがVPCにアタッチされているか確認してください
- ルートテーブルにインターネットゲートウェイへのルート（0.0.0.0/0）が設定されているか確認してください

### 画面は表示されるが、BMI計算ができない
- WebサーバからAPIサーバへの通信が可能か確認してください（セキュリティグループ、ルートテーブル）
- userdataに設定したAPIサーバのIPアドレスが正しいか確認してください

### userdataの実行が成功したか確認したい
userdataが正常に実行されたかどうかは、EC2インスタンスにSSH接続してログを確認することで調査できます。

#### 1. SSH接続を許可する
トラブルシューティングのため、一時的にSSH接続を許可しましょう。
- **Webサーバ**: セキュリティグループでインターネットからの22ポート通信を許可する
- **APIサーバ**: セキュリティグループでWebサーバからの22ポート通信を許可する

#### 2. EC2インスタンスに接続する
- Webサーバには、パブリックIPアドレスを使用してSSH接続します
- APIサーバには、Webサーバを経由してSSH接続します（Webサーバに秘密鍵を配置する必要があります）

#### 3. ログを確認する
以下のコマンドでuserdataの実行ログを確認できます。
```bash
sudo cat /var/log/cloud-init-output.log
```
- ログの末尾に `finished` や `SUCCESS` と表示されていれば正常に完了しています
- エラーが発生している場合は、ログ内のエラーメッセージを確認してください