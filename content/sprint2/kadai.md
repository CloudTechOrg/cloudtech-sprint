# スプリント2：データベース ハンズオン課題

## 背景

あなたは、とあるWebサービスを運営する企業で、インフラエンジニアとして働いています。

この度、新しく自社サービスとして「名簿管理API」をリリースすることになりました。

すでにアプリケーション開発チームがAPIの開発を完了しています。APIのデータを保存するためのDBサーバはインフラエンジニアであるあなたが構築する必要があります。

あなたはインフラエンジニアとして、これらのアプリケーションが正常に動作するインフラ環境を構築する必要があります。

## 実施手順

1. まずは要件を実現するための設計として、AWS構成図を作成しましょう。
2. 構成図に従い、実際にAWSで環境構築してみましょう。
3. 構築が終わったら、動作確認をしていきましょう。

## 要件

### 要件1：APIサーバ
- GoのAPIを実行するためのAPIサーバをEC2インスタンスで構成する
- EC2インスタンスのAMIはAmazon Linux 2023を使用する
- 初期構築は、別途提示されるシェルスクリプトをEC2のユーザデータにて実行することで行う

#### APIサーバの構築方法
- [こちら](https://github.com/CloudTechOrg/sprint2-api/blob/main/userdata/api_userdata.sh)をuserdataで実行してください
- `DB_HOST`にはRDSのエンドポイントを設定してください
- `DB_USER`にはRDSのマスターユーザー名を設定してください
- `DB_PASSWORD`にはRDSのマスターパスワードを設定してください

#### APIの使い方
- [こちら](https://github.com/CloudTechOrg/sprint2-api/blob/main/README.md)に、APIの操作方法が記載されています

### 要件2：DBサーバ
- DBサーバとしてRDSインスタンスを構成する
- RDSのDBエンジンはMySQLを使用する
- データベース名は `meibo` とする

### 要件3：踏み台サーバ
- RDSへ接続してメンテナンスを行うための踏み台サーバを作成する
- 踏み台サーバのAMIはAmazon Linux 2023を使用する

#### 踏み台サーバからRDSへ接続する方法
踏み台サーバにSSH接続後、以下の手順でMySQLクライアントをインストールし、RDSへ接続します。

```bash
# MySQLクライアントのインストール
sudo dnf install -y mariadb105

# RDSへ接続
mysql -h <RDSのエンドポイント> -u <マスターユーザー名> -p
```

### 要件4：アクセス制御
- APIサーバはインターネットからの80ポート（HTTP）通信を許可する
- 踏み台サーバはインターネットからの22ポート（SSH）通信を許可する
- DBサーバ（RDS）はAPIサーバ及び踏み台サーバからの3306ポート（MySQL）通信のみ許可する

### 要件5：権限管理
社内には開発チームとDBチームが存在します。それぞれのチームが担当するリソースのみを操作できるように、権限を分離してください。

| チーム | 操作できるリソース |
| :--- | :--- |
| 開発チーム | APIサーバ（EC2）の起動・停止・再起動、SSH接続 |
| DBチーム | 踏み台サーバ（EC2）へのSSH接続、RDSの起動・停止・再起動 |

## 提出物

下記が実装されていることがわかるスクリーンショットを提出してください。

### 要件1：APIサーバ
- APIサーバがEC2インスタンスで構成されていること

### 要件2：DBサーバ
- RDSインスタンスが作成されていること
- DBエンジンはMySQLが使用されていること

### 要件3：踏み台サーバ
- 踏み台サーバが作成されていること

### 要件4：アクセス制御
- APIサーバで、インターネット（0.0.0.0/0）からの80ポート（HTTP）通信が許可されていること
- 踏み台サーバで、インターネット（0.0.0.0/0）からの22ポート（SSH）通信が許可されていること
- DBサーバ（RDS）で、APIサーバ及び踏み台サーバからの3306ポート（MySQL）通信のみ許可されていること

### 要件5：権限管理
- 開発チーム用の権限設定が作成されていること
- 開発チームがAPIサーバ（EC2）の起動・停止・再起動、SSH接続のみ可能であること
- DBチーム用の権限設定が作成されていること
- DBチームが踏み台サーバ（EC2）へのSSH接続、RDSの起動・停止・再起動のみ可能であること

## 動作確認
- APIサーバのパブリックIPアドレスにブラウザまたはcurlでアクセスし、APIが動作すること
    - 例：`curl http://<IPアドレス>/users`
- 踏み台サーバからRDSにMySQLクライアントで接続できること
    - 例：`mysql -h <RDSのエンドポイント> -u <マスターユーザー名> -p`
- 各チームが担当リソースのみ操作できること（権限外の操作が拒否されること）

## ヒント
- EC2のインスタンスタイプは `t2.micro` を使用すると、無料利用枠の対象となります。
- RDSのインスタンスクラスは `db.t3.micro` または `db.t4g.micro` を使用すると、無料利用枠の対象となります。

## トラブルシューティング

### APIサーバにブラウザからアクセスできない
- セキュリティグループで80ポートが許可されているか確認してください
- APIサーバにパブリックIPアドレス（またはElastic IP）が割り当てられているか確認してください
- インターネットゲートウェイがVPCにアタッチされているか確認してください
- ルートテーブルにインターネットゲートウェイへのルート（0.0.0.0/0）が設定されているか確認してください

### APIからDBへの接続ができない
- RDSのセキュリティグループで、APIサーバからの3306ポート通信が許可されているか確認してください
- userdataに設定したRDSのエンドポイント、ユーザー名、パスワードが正しいか確認してください
- RDSが配置されているサブネットへのルーティングが設定されているか確認してください

### APIの接続でデータベース接続エラーがです
```
curl: (28) Failed to connect to 13.159.193.155 port 80 after 75006 ms: Couldn't connect to server
```

### 踏み台サーバからRDSに接続できない
- RDSのセキュリティグループで、踏み台サーバからの3306ポート通信が許可されているか確認してください
- RDSのエンドポイントが正しいか確認してください
- マスターユーザー名とパスワードが正しいか確認してください

### userdataの実行が成功したか確認したい
userdataが正常に実行されたかどうかは、EC2インスタンスにSSH接続してログを確認することで調査できます。

#### 1. SSH接続を許可する
トラブルシューティングのため、一時的にSSH接続を許可しましょう。
- **APIサーバ**: セキュリティグループでインターネットからの22ポート通信を許可する

#### 2. ログを確認する
以下のコマンドでuserdataの実行ログを確認できます。
```bash
sudo cat /var/log/cloud-init-output.log
```
- ログの末尾に `finished` や `SUCCESS` と表示されていれば正常に完了しています
- エラーが発生している場合は、ログ内のエラーメッセージを確認してください
