# スプリント2：データベース ハンズオン課題

## 背景

あなたは、とあるWebサービスを運営する企業で、インフラエンジニアとして働いています。

この度、新しく自社サービスとして「名簿管理API」をリリースすることになりました。

すでにアプリケーション開発チームがAPIの開発を完了しています。APIのデータを保存するためのDBサーバはインフラエンジニアであるあなたが構築する必要があります。

あなたはインフラエンジニアとして、これらのアプリケーションが正常に動作するインフラ環境を構築する必要があります。

## 実施手順

1. まずは要件を実現するための設計として、AWS構成図を作成しましょう。
2. 構成図に従い、実際にAWSで環境構築してみましょう。
3. 構築が終わったら、動作確認をしていきましょう。

## 要件

### 要件1：APIサーバ
- GoのAPIを実行するためのAPIサーバをEC2インスタンスで構成する
- EC2インスタンスのAMIはAmazon Linux 2023を使用する
- 初期構築は、別途提示されるシェルスクリプトをEC2のユーザデータにて実行することで行う

#### APIサーバの構築方法
- [こちら](https://github.com/CloudTechOrg/sprint2-api/blob/main/userdata/api_userdata.sh)をuserdataで実行してください
- `DB_HOST`にはRDSのエンドポイントを設定してください
- `DB_USER`にはRDSのマスターユーザー名を設定してください
- `DB_PASSWORD`にはRDSのマスターパスワードを設定してください

#### APIの使い方
- [こちら](https://github.com/CloudTechOrg/sprint2-api/blob/main/README.md)に、APIの操作方法が記載されています

### 要件2：DBサーバ
- DBサーバとしてRDSインスタンスを構成する
- RDSのDBエンジンはMySQLを使用する
- データベース名は `meibo` とする

### 要件3：踏み台サーバ
- RDSへ接続してメンテナンスを行うための踏み台サーバを作成する
- 踏み台サーバのAMIはAmazon Linux 2023を使用する

#### 踏み台サーバからRDSへ接続する方法
踏み台サーバにSSH接続後、以下の手順でMySQLクライアントをインストールし、RDSへ接続します。

```bash
# MySQLクライアントのインストール
sudo dnf install -y mariadb105

# RDSへ接続
mysql -h <RDSのエンドポイント> -u <マスターユーザー名> -p
```

### 要件4：アクセス制御
- APIサーバはインターネットからの80ポート（HTTP）通信を許可する
- 踏み台サーバはインターネットからの22ポート（SSH）通信を許可する
- DBサーバ（RDS）はAPIサーバ及び踏み台サーバからの3306ポート（MySQL）通信のみ許可する

### 要件5：権限管理
社内には開発チームとDBチームが存在します。それぞれのチームが担当するリソースのみを操作できるように、権限を分離してください。

| チーム | 操作できるリソース |
| :--- | :--- |
| 開発チーム | APIサーバ（EC2）の起動・停止・再起動、SSH接続 |
| DBチーム | 踏み台サーバ（EC2）へのSSH接続、RDSの起動・停止・再起動 |

## ヒント
- EC2のインスタンスタイプは `t2.micro` を使用すると、無料利用枠の対象となります。
- RDSのインスタンスクラスは `db.t3.micro` または `db.t4g.micro` を使用すると、無料利用枠の対象となります。

## 構築チェックリスト

下記が実装されていることを確認してください。

### 要件1：APIサーバ
- APIサーバがEC2インスタンスで構成されていること

### 要件2：DBサーバ
- RDSインスタンスが作成されていること
- DBエンジンはMySQLが使用されていること

### 要件3：踏み台サーバ
- 踏み台サーバが作成されていること

### 要件4：アクセス制御
- APIサーバで、インターネット（0.0.0.0/0）からの80ポート（HTTP）通信が許可されていること
- 踏み台サーバで、インターネット（0.0.0.0/0）からの22ポート（SSH）通信が許可されていること
- DBサーバ（RDS）で、APIサーバ及び踏み台サーバからの3306ポート（MySQL）通信のみ許可されていること

### 要件5：権限管理
- 開発チーム用の権限設定が作成されていること
- 開発チームがAPIサーバ（EC2）の起動・停止・再起動、SSH接続のみ可能であること
- DBチーム用の権限設定が作成されていること
- DBチームが踏み台サーバ（EC2）へのSSH接続、RDSの起動・停止・再起動のみ可能であること

## 動作確認
### APIの実行（登録）
ターミナル（Mac）またはコマンドプロンプト（Windows）で以下のCURLコマンドを実行し、期待する結果が返ってくること

＜CURLコマンド＞

※ ＜APIサーバのパブリックIPアドレス＞は実際の値に置き換えてください
```
curl -X POST http://＜APIサーバのパブリックIPアドレス＞/api/persons \
  -H "Content-Type: application/json" \
  -d '{"name": "山田太郎", "email": "yamada@example.com", "phone": "090-1234-5678"}'
{"id":2,"name":"山田太郎","email":"yamada@example.com","phone":"090-1234-5678"}
```

＜期待結果＞
```
{"id":2,"name":"山田太郎","email":"yamada@example.com","phone":"090-1234-5678"}
```

### APIの実行（検索）
ターミナル（Mac）またはコマンドプロンプト（Windows）で以下のCURLコマンドを実行し、期待する結果が返ってくること

＜CURLコマンド＞
※ ＜APIサーバのパブリックIPアドレス＞は実際の値に置き換えてください

```
curl http://＜APIサーバのパブリックIPアドレス＞/api/persons
```

＜期待結果＞
```
[{"id":1,"name":"山田太郎","email":"yamada@example.com","phone":"090-1234-5678"}]
```

### 踏み台サーバからRDSへの接続
以下のコマンドで、踏み台サーバからRDSのMySQLに接続（ログイン）できること
（最後にMySQL [(none)]> と表示されればOK）
-  <RDSのエンドポイント>、<マスターユーザー名>は実際の値に置き換えてください
-  コマンド入力後、パスワードの入力を求められます（RDS構築時に指定したもの）
```
mysql -h <RDSのエンドポイント> -u <マスターユーザー名> -p
```

### 踏み台サーバでデータの検索
以下のコマンドで、APIから登録したデータが検索できること
（先にAPIにてデータ登録の動作確認を行っている前提）
```
SELECT * FROM meibo.persons;
```

## 理解度の確認
この課題の理解度を確認するため、以下の内容を言語化してみましょう。

### 問題1：IAMの構成要素
IAMを構成する要素として、IAMユーザ、IAMグループ、IAMポリシー、IAMロールがあります。それぞれの違いや用途について、実際の利用シーンを交えながら説明してください。

### 問題2：AWSの操作方法
AWSを操作する方法として、マネジメントコンソール、AWS CLI、AWS SDKの3つがあります。それぞれの違いや用途について、実際の利用シーンを交えながら説明してください。

### 問題3：RDSを利用するメリット
データベースを構築する際、EC2などのサーバに直接データベースソフトをインストールする方法と比較して、RDSを使って構築する場合にいくつかのメリット・デメリットがあります。
これらについて、具体的な利用シーンを交えながらあなたの考えを考察してください。
なお、説明の際には「運用・保守」、「可用性」の観点を加えてください。

### 問題4：RDSの可用性
RDSを利用したシステム設計において、システムの安定稼働（信頼性）を高めるための手段はいくつか存在します。 以下の3つの要件が発生した場合、それぞれRDSのどのような機能を用いればよいか、仕組みと実際の利用イメージを交えて説明してください。
1. 高頻度の読み込み処理が発生しており、RDS本体（プライマリ）への負荷を最小限に抑えたい。
2. データセンター単位の障害など、一部の設備や地域に障害が発生した場合にも、システムを停止させずに稼働させ続けたい。
3. 国家レベルの大規模災害が発生した場合も、データの保護や別拠点での復旧を可能としたい。

## トラブルシューティング

### APIサーバにブラウザからアクセスできない
- セキュリティグループで80ポートが許可されているか確認してください
- APIサーバにパブリックIPアドレス（またはElastic IP）が割り当てられているか確認してください
- インターネットゲートウェイがVPCにアタッチされているか確認してください
- ルートテーブルにインターネットゲートウェイへのルート（0.0.0.0/0）が設定されているか確認してください

### APIからDBへの接続ができない
- RDSのセキュリティグループで、APIサーバからの3306ポート通信が許可されているか確認してください
- userdataに設定したRDSのエンドポイント、ユーザー名、パスワードが正しいか確認してください
- RDSが配置されているサブネットへのルーティングが設定されているか確認してください

### APIの接続でデータベース接続エラーがです
```
curl: (28) Failed to connect to 13.159.193.155 port 80 after 75006 ms: Couldn't connect to server
```

### 踏み台サーバからRDSに接続できない
- RDSのセキュリティグループで、踏み台サーバからの3306ポート通信が許可されているか確認してください
- RDSのエンドポイントが正しいか確認してください
- マスターユーザー名とパスワードが正しいか確認してください

### userdataの実行が成功したか確認したい
userdataが正常に実行されたかどうかは、EC2インスタンスにSSH接続してログを確認することで調査できます。

#### 1. SSH接続を許可する
トラブルシューティングのため、一時的にSSH接続を許可しましょう。
- **APIサーバ**: セキュリティグループでインターネットからの22ポート通信を許可する

#### 2. ログを確認する
以下のコマンドでuserdataの実行ログを確認できます。
```bash
sudo cat /var/log/cloud-init-output.log
```
- ログの末尾に `finished` や `SUCCESS` と表示されていれば正常に完了しています
- エラーが発生している場合は、ログ内のエラーメッセージを確認してください
