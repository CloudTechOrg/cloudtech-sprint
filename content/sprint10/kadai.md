# スプリント10：ワークフロー自動化 ハンズオン課題

## 背景

あなたは、とある小売企業で、インフラエンジニアとして働いています。

現在、毎月の売上レポートは経理担当者が手動で作成しています。具体的には以下の作業を行っています。

1. 売上データ（CSVファイル）をダウンロードする
2. Excelで集計処理を行う
3. レポートを作成する
4. 関係者にメールで送付する

この作業は毎月1日に行われますが、以下の課題があります。

- 手作業のため、ヒューマンエラーが発生するリスクがある
- 担当者が不在の場合、レポート作成が遅れる
- 集計ロジックがExcelに依存しており、属人化している

これらの課題を解決するため、**ワークフローの自動化**を行い、売上データの集計からレポート送付までを自動化することになりました。

あなたはインフラエンジニアとして、このワークフロー自動化の仕組みを構築する必要があります。

## 実施手順

1. まずは要件を実現するための設計として、AWS構成図を作成しましょう。
2. 構成図に従い、実際にAWSで環境構築してみましょう。
3. 構築が終わったら、動作確認をしていきましょう。

## プロジェクト体制

| 担当 | チーム | 役割・タスク |
| :--- | :--- | :--- |
| **あなた** | インフラチーム | ・AWS構成図作成<br>・AWS環境構築<br>・関数コードの作成 |
| **メンター** | 支援チーム | ・成果物のレビュー<br>・技術サポート (CloudTech Academy受講生のみ) |

## 要件

### 要件1：売上データの準備
- ストレージに売上データ（CSVファイル）を配置する
- CSVファイルのフォーマットは下記「売上データのサンプル」を参照

### 要件2：スケジュール実行
- 毎月1日の午前9時に自動的にワークフローが開始されるようにする
- スケジュールに基づいてイベントを発火させる仕組みを使用する

### 要件3：ワークフローの構築
- 複数の処理を順番に実行するワークフローを構築する
- 各処理の成功・失敗に応じて適切にハンドリングする
- 処理の状態を可視化できるようにする

### 要件4：売上データ集計関数
- ストレージからCSVファイルを読み込む
- 以下の集計を行う
  - 商品カテゴリ別の売上合計
  - 日別の売上合計
  - 総売上金額
- 集計結果を次の処理に渡す

### 要件5：レポート作成関数
- 集計データを受け取り、レポートを作成する
- レポートは下記「レポートフォーマット」の形式で作成する
- 作成したレポートをストレージに保存する
- レポート作成完了後、メール送信用のメッセージをキューに送信する

### 要件6：メッセージキューによる非同期処理
- レポート作成関数からメール送信関数への連携は、メッセージキューを使用して非同期で行う
- これにより、ワークフローの処理時間とメール送信処理を分離できる
- メッセージキューにメッセージが入ると、自動的にメール送信関数が起動する

### 要件7：メール送信関数
- キューからメッセージを受け取り、レポートをメールで送信する
- 宛先は設定で変更可能にする
- メール本文にはレポートの概要を記載する

### 要件8：エラーハンドリング
- メール送信に失敗した場合、一定回数リトライする
- リトライしても失敗したメッセージは、別のキュー（失敗用）に移動して保持する
- 失敗したメッセージは後から確認・再処理できるようにする

## 売上データのサンプル

以下のCSVファイルをストレージにアップロードしてください。

**ファイル名**: `sales_202401.csv`

```csv
date,product_id,product_name,category,quantity,unit_price,total_price
2024-01-01,P001,ノートPC,電子機器,5,80000,400000
2024-01-01,P002,マウス,電子機器,20,2000,40000
2024-01-01,P003,デスク,家具,3,25000,75000
2024-01-02,P001,ノートPC,電子機器,3,80000,240000
2024-01-02,P004,チェア,家具,10,15000,150000
2024-01-02,P005,モニター,電子機器,8,30000,240000
2024-01-03,P002,マウス,電子機器,15,2000,30000
2024-01-03,P003,デスク,家具,2,25000,50000
2024-01-03,P006,キーボード,電子機器,12,5000,60000
2024-01-04,P001,ノートPC,電子機器,2,80000,160000
2024-01-04,P004,チェア,家具,5,15000,75000
2024-01-04,P005,モニター,電子機器,6,30000,180000
2024-01-05,P002,マウス,電子機器,25,2000,50000
2024-01-05,P006,キーボード,電子機器,10,5000,50000
2024-01-05,P003,デスク,家具,4,25000,100000
```

## レポートフォーマット

レポートは以下のテキスト形式で作成してください。

**ファイル名**: `sales_report_202401.txt`

```
=====================================
        月次売上レポート
        対象期間: 2024年1月
=====================================

【総売上】
  合計金額: ¥1,900,000

【カテゴリ別売上】
  電子機器: ¥1,450,000
  家具: ¥450,000

【日別売上】
  2024-01-01: ¥515,000
  2024-01-02: ¥630,000
  2024-01-03: ¥140,000
  2024-01-04: ¥415,000
  2024-01-05: ¥200,000

【トップ3商品】
  1. ノートPC: ¥800,000
  2. モニター: ¥420,000
  3. チェア: ¥225,000

=====================================
        レポート作成日時: 2024-02-01 09:00:00
=====================================
```

## 動作確認

### 1. 手動実行での確認
まずはワークフローを手動で実行し、正常に動作することを確認します。

1. ストレージに売上データ（CSV）をアップロード
2. ワークフローを手動で開始
3. 各処理が順番に実行されることを確認
4. レポートがストレージに保存されることを確認
5. キューにメッセージが送信されることを確認
6. メール送信関数が起動し、メールが送信されることを確認

### 2. スケジュール実行の確認
スケジュール設定が正しく動作することを確認します。

1. テスト用に直近の時刻でスケジュールを設定
2. 指定時刻にワークフローが自動開始されることを確認

### 3. エラーハンドリングの確認
メール送信失敗時の動作を確認します。

1. 意図的にメール送信を失敗させる（例：無効な宛先を設定）
2. 指定回数リトライされることを確認
3. 失敗したメッセージが失敗用キューに移動することを確認

## ヒント
- AWSには複数の処理を順番に実行するワークフローサービスがあります
- スケジュール実行には、イベントを管理するサービスを使用します
- 関数間でデータを受け渡す方法を検討してください
- メール送信には、送信元アドレスの検証が必要です
- 非同期処理を行う場合は、メッセージを一時的に保持するキューサービスが便利です
- キューサービスには、処理に失敗したメッセージを別のキューに移動する機能があります

## トラブルシューティング

### EventBridgeのスケジュールが動作しない
- ルールが有効になっているか確認してください
- cron式の記述が正しいか確認してください（UTCで指定する必要があります）
- ターゲットにStep Functionsが正しく設定されているか確認してください
- EventBridgeにStep Functionsを実行する権限があるか確認してください

### Step Functionsのワークフローが失敗する
- ステートマシンの定義（ASL）が正しいか確認してください
- 各ステートの入出力の形式が正しいか確認してください
- CloudWatch Logsで実行ログを確認してください
- Step Functionsの実行ロールにLambda関数を呼び出す権限があるか確認してください

### Lambda関数がS3からファイルを読み込めない
- Lambda関数の実行ロールに `s3:GetObject` 権限があるか確認してください
- バケット名とオブジェクトキーが正しいか確認してください
- S3バケットポリシーでアクセスが許可されているか確認してください

### Lambda関数でCSVの解析に失敗する
- CSVファイルの文字コードがUTF-8になっているか確認してください
- ファイルの改行コードを確認してください
- Pythonの場合、`csv`モジュールまたは`pandas`ライブラリの使い方を確認してください

### SESでメール送信に失敗する
- 送信元メールアドレスがSESで検証済みか確認してください
- サンドボックス環境の場合、送信先も検証済みである必要があります
- Lambda関数の実行ロールに `ses:SendEmail` 権限があるか確認してください
- リージョンによってSESが利用できない場合があります（東京リージョンで利用可能）

### SQSのメッセージが処理されない
- SQSキューが作成されているか確認してください
- Lambda関数のトリガーにSQSが設定されているか確認してください
- Lambda関数の実行ロールに `sqs:ReceiveMessage`, `sqs:DeleteMessage` 権限があるか確認してください
- 可視性タイムアウトがLambda関数のタイムアウトより長いか確認してください

### デッドレターキュー（DLQ）の設定
- メインのSQSキューにデッドレターキューを設定してください
- `maxReceiveCount`（最大受信回数）を設定してください（推奨：3回）
- 指定回数失敗したメッセージは自動的にDLQに移動します
- DLQに溜まったメッセージは、CloudWatchアラームで監視することを推奨します

### 失敗したメッセージの確認方法
- AWSマネジメントコンソールからSQSのデッドレターキューを開いてください
- 「メッセージを送受信」からメッセージの内容を確認できます
- 問題を修正後、メッセージをメインキューに戻して再処理できます

### Step Functionsでの入出力のデータ形式
```json
// 集計関数の出力例
{
  "total_sales": 1900000,
  "category_sales": {
    "電子機器": 1450000,
    "家具": 450000
  },
  "daily_sales": {
    "2024-01-01": 515000,
    "2024-01-02": 630000
  },
  "top_products": [
    {"name": "ノートPC", "sales": 800000},
    {"name": "モニター", "sales": 420000}
  ]
}
```

### Lambda関数のサンプルコード（集計処理）
```python
import json
import boto3
import csv
from io import StringIO

def lambda_handler(event, context):
    s3 = boto3.client('s3')

    # S3からCSVファイルを読み込み
    bucket = event['bucket']
    key = event['key']

    response = s3.get_object(Bucket=bucket, Key=key)
    content = response['Body'].read().decode('utf-8')

    # CSV解析と集計処理
    reader = csv.DictReader(StringIO(content))

    total_sales = 0
    category_sales = {}
    daily_sales = {}

    for row in reader:
        price = int(row['total_price'])
        total_sales += price

        # カテゴリ別集計
        category = row['category']
        category_sales[category] = category_sales.get(category, 0) + price

        # 日別集計
        date = row['date']
        daily_sales[date] = daily_sales.get(date, 0) + price

    return {
        'statusCode': 200,
        'total_sales': total_sales,
        'category_sales': category_sales,
        'daily_sales': daily_sales
    }
```
