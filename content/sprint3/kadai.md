# スプリント3：ELB/AutoScaling ハンズオン課題

## 背景

あなたは、とあるWebサービスを運営する企業で、インフラエンジニアとして働いています。

この度、新しく自社サービスとして「おみくじAPI」をリリースすることになりました。

すでにアプリケーション開発チームがAPIの開発を完了しています。このAPIは人気サービスになることが予想されるため、高可用性とスケーラビリティを考慮した構成が求められています。

あなたはインフラエンジニアとして、ELB（Elastic Load Balancing）による冗長化と、Auto Scalingによる自動スケーリングを実現するインフラ環境を構築する必要があります。

## 実施手順

1. まずは要件を実現するための設計として、AWS構成図を作成しましょう。
2. 構成図に従い、実際にAWSで環境構築してみましょう。
3. 構築が終わったら、動作確認をしていきましょう。

## 要件

### 要件1：APIサーバ
- おみくじAPIを実行するためのAPIサーバをEC2インスタンスで構成する
- EC2インスタンスのAMIはAmazon Linux 2023を使用する
- 初期構築は、別途提示されるシェルスクリプトをEC2のユーザデータにて実行することで行う

#### APIサーバの構築方法
- [こちら](https://github.com/CloudTechOrg/sprint3-api/blob/main/userdata/api_userdata.sh)をuserdataで実行してください

#### APIの使い方
- [こちら](https://github.com/CloudTechOrg/sprint3-api/blob/main/README.md)に、APIの操作方法が記載されています

### 要件2：ロードバランサー（ELB）
- ロードバランサーを使用して、複数のAPIサーバに負荷分散する
- 複数のアベイラビリティゾーンに分散配置する

### 要件3：Auto Scaling
- EC2インスタンスは通常2台で構成する
- CPU使用率が70%を超えたら、新しいEC2インスタンスを増やす
- 最大4台まで増やすことができる

### 要件4：アクセス制御
- ロードバランサーはインターネットからの80ポート（HTTP）通信を許可する
- APIサーバはロードバランサーからの80ポート通信のみ許可する（インターネットからの直接アクセスは拒否）
- APIサーバはインターネットから直接アクセスできないが、ソフトウェアのインストールのためにインターネットへのアウトバウンド通信は可能にする

## ヒント
- EC2のインスタンスタイプは `t2.micro` を使用すると、無料利用枠の対象となります。

## 構築チェックリスト

下記が実装されていることを確認してください。

### 要件1：APIサーバ
- APIサーバがEC2インスタンスで構成されていること

### 要件2：ロードバランサー
- ロードバランサーが作成されていること
- 複数のAPIサーバに負荷分散されていること
- 複数のアベイラビリティゾーンに分散配置されていること

### 要件3：Auto Scaling
- Auto Scalingが設定されていること
- CPU使用率が70%を超えた場合にスケールアウトすること
- 最低2台、最大4台までスケールできること

### 要件4：アクセス制御
- ロードバランサーで、インターネット（0.0.0.0/0）からの80ポート（HTTP）通信が許可されていること
- APIサーバで、ロードバランサーからの80ポート通信のみ許可されていること
- APIサーバで、インターネットからの直接アクセスが拒否されていること
- APIサーバで、アウトバウンド通信が許可されていること

## 動作確認
ターミナル（Mac）またはコマンドプロンプト（Windows）で以下のCURLコマンドを実行し、期待する結果が返ってくること

＜CURLコマンド＞

※ ＜ALBのドメイン名＞は実際の値に置き換えてください

```
curl -X GET http://＜ALBのドメイン名＞/omikuji \
```

＜期待結果＞
以下の内容がランダムで表示されます。
```
{"result":"大凶","message":"今日は控えめに過ごしましょう。"}

{"result":"凶","message":"慎重に行動することをお勧めします。"}

{"result":"末吉","message":"努力が実を結ぶ兆しがあります。"}

{"result":"小吉","message":"小さな幸せが訪れるでしょう。"}

{"result":"中吉","message":"良いことが起こりそうな予感です。"}

"result":"大吉","message":"すべてがうまくいく最高の運勢です！"}
```

## 理解度の確認
この課題の理解度を確認するため、以下の内容を言語化してみましょう。

### 問題1：ロードバランサーの特徴
AWSなどのクラウドを構成する重要な要素である「ロードバランサー」について、以下の点を含めて説明してください。
1. ロードバランサーの主な役割・特徴 
2. 導入することで得られるメリット 
4. どのような場面で利用されるか（具体的な利用シーン）

### 問題2：ALBとNLB
AWSのElastic Load Balancing（ELB）が提供するロードバランサーとして、Application Load Balancer（ALB）とNetwork Load Balancer（NLB）が挙げられます。これら2つのロードバランサーについて、動作するレイヤーや機能面での主な違いを対比し、それぞれの具体的な利用シーンを交えて説明してください。

### 問題3：Auto Scalingの特徴
AWSなどのクラウドを特徴付ける機能の一つとしてAuto Scalingが挙げられます。Auto Acalingについて、以下の点を含めて説明してください。
1. Auto Scalingの主な役割・特徴 
2. 導入することで得られるメリット 
3. どのような場面で利用されるか（具体的な利用シーン）

###  問題4：スケーリングポリシーの種類
AWS Auto Scaling（Amazon EC2 Auto Scaling）では、どのような条件でインスタンス数の増減（スケーリング）を行うかを「スケーリングポリシー」によって定義します。代表的なスケーリングポリシーの種類を挙げ、それぞれの仕組みと、どのような要件に適しているか具体的な利用シーンを交えて説明してください。

## トラブルシューティング

### ロードバランサーにアクセスできない
- ロードバランサーのセキュリティグループで80ポートが許可されているか確認してください
- ロードバランサーが配置されているサブネットにインターネットゲートウェイへのルートがあるか確認してください
- ターゲットグループにインスタンスが登録されているか確認してください

### ターゲットグループでインスタンスがunhealthyになる
- EC2のセキュリティグループでロードバランサーからの80ポート通信が許可されているか確認してください
- EC2インスタンスでAPIアプリケーションが正常に起動しているか確認してください

### Auto Scalingでインスタンスが起動しない
- 起動テンプレートの設定（AMI、インスタンスタイプ、セキュリティグループ等）が正しいか確認してください
- Auto Scalingグループに設定したサブネットが正しいか確認してください

### userdataの実行が成功したか確認したい
userdataが正常に実行されたかどうかは、EC2インスタンスにSSH接続してログを確認することで調査できます。

#### 1. SSH接続を許可する
トラブルシューティングのため、一時的にSSH接続を許可しましょう。
- **APIサーバ**: セキュリティグループでインターネットからの22ポート通信を許可する

#### 2. ログを確認する
以下のコマンドでuserdataの実行ログを確認できます。
```bash
sudo cat /var/log/cloud-init-output.log
```
- ログの末尾に `finished` や `SUCCESS` と表示されていれば正常に完了しています
- エラーが発生している場合は、ログ内のエラーメッセージを確認してください
