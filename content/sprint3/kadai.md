# スプリント3：ELB/AutoScaling ハンズオン課題

## 背景

あなたは、とあるWebサービスを運営する企業で、インフラエンジニアとして働いています。

この度、新しく自社サービスとして「おみくじAPI」をリリースすることになりました。

すでにアプリケーション開発チームがAPIの開発を完了しています。このAPIは人気サービスになることが予想されるため、高可用性とスケーラビリティを考慮した構成が求められています。

あなたはインフラエンジニアとして、ELB（Elastic Load Balancing）による冗長化と、Auto Scalingによる自動スケーリングを実現するインフラ環境を構築する必要があります。

## 実施手順

1. まずは要件を実現するための設計として、AWS構成図を作成しましょう。
2. 構成図に従い、実際にAWSで環境構築してみましょう。
3. 構築が終わったら、動作確認をしていきましょう。

## プロジェクト体制

| 担当 | チーム | 役割・タスク |
| :--- | :--- | :--- |
| **開発担当** | 開発チーム | ・アプリケーション開発<br>・サーバ構築のシェルスクリプト作成 |
| **あなた** | インフラチーム | ・AWS構成図作成<br>・AWS環境構築 |
| **メンター** | 支援チーム | ・成果物のレビュー<br>・技術サポート (CloudTech Academy受講生のみ) |

## 要件

### 要件1：APIサーバ
- おみくじAPIを実行するためのAPIサーバをEC2インスタンスで構成する
- EC2インスタンスのAMIはAmazon Linux 2023を使用する
- 初期構築は、別途提示されるシェルスクリプトをEC2のユーザデータにて実行することで行う

#### APIサーバの構築方法
- [こちら](https://github.com/CloudTechOrg/sprint3-api/blob/main/userdata/api_userdata.sh)をuserdataで実行してください

#### APIの使い方
- [こちら](https://github.com/CloudTechOrg/sprint3-api/blob/main/README.md)に、APIの操作方法が記載されています

### 要件2：ロードバランサー（ELB）
- ロードバランサーを使用して、複数のAPIサーバに負荷分散する
- 複数のアベイラビリティゾーンに分散配置する

### 要件3：Auto Scaling
- EC2インスタンスは通常2台で構成する
- CPU使用率が70%を超えたら、新しいEC2インスタンスを増やす
- 最大4台まで増やすことができる

### 要件4：アクセス制御
- ロードバランサーはインターネットからの80ポート（HTTP）通信を許可する
- APIサーバはロードバランサーからの80ポート通信のみ許可する（インターネットからの直接アクセスは拒否）
- APIサーバはインターネットから直接アクセスできないが、ソフトウェアのインストールのためにインターネットへのアウトバウンド通信は可能にする

## ヒント
- EC2のインスタンスタイプは `t2.micro` を使用すると、無料利用枠の対象となります。

## 動作確認

### 1. ロードバランサー経由でのアクセス確認
ロードバランサーのDNS名を使用してAPIにアクセスし、おみくじの結果が返ることを確認します。

```bash
# おみくじを引く
curl http://<ロードバランサーのDNS名>/omikuji
```

レスポンス例：
```json
{
  "result": "大吉",
  "message": "すべてがうまくいく最高の運勢です！"
}
```

### 2. 負荷分散の確認
複数回アクセスし、異なるインスタンスに振り分けられていることを確認します。

```bash
# ホスト名を確認（インスタンスIDが返る）
for i in {1..10}; do curl http://<ロードバランサーのDNS名>/hostname; echo; done
```

### 3. Auto Scalingの動作確認
負荷をかけてスケールアウトが発生することを確認します。

```bash
# 負荷テスト用エンドポイント（CPU負荷をかける）
curl http://<ロードバランサーのDNS名>/stress
```

しばらく待つと、CloudWatchアラームがトリガーされ、新しいインスタンスが起動します。

## トラブルシューティング

### ロードバランサーにアクセスできない
- ロードバランサーのセキュリティグループで80ポートが許可されているか確認してください
- ロードバランサーが配置されているサブネットにインターネットゲートウェイへのルートがあるか確認してください
- ターゲットグループにインスタンスが登録されているか確認してください

### ターゲットグループでインスタンスがunhealthyになる
- EC2のセキュリティグループでロードバランサーからの80ポート通信が許可されているか確認してください
- EC2インスタンスでAPIアプリケーションが正常に起動しているか確認してください

### Auto Scalingでインスタンスが起動しない
- 起動テンプレートの設定（AMI、インスタンスタイプ、セキュリティグループ等）が正しいか確認してください
- Auto Scalingグループに設定したサブネットが正しいか確認してください

### userdataの実行が成功したか確認したい
userdataが正常に実行されたかどうかは、EC2インスタンスにSSH接続してログを確認することで調査できます。

#### 1. SSH接続を許可する
トラブルシューティングのため、一時的にSSH接続を許可しましょう。
- **APIサーバ**: セキュリティグループでインターネットからの22ポート通信を許可する

#### 2. ログを確認する
以下のコマンドでuserdataの実行ログを確認できます。
```bash
sudo cat /var/log/cloud-init-output.log
```
- ログの末尾に `finished` や `SUCCESS` と表示されていれば正常に完了しています
- エラーが発生している場合は、ログ内のエラーメッセージを確認してください
