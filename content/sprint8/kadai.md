# スプリント8：サーバレス ハンズオン課題

## 背景

あなたは、とあるWebサービスを運営する企業で、インフラエンジニアとして働いています。

この度、社内向けの「メモアプリAPI」を新規開発することになりました。
（Sprint2で作成した名簿管理APIと同様のCRUD操作を行うAPIです）

このアプリは利用頻度が読めないため、従来のサーバベースの構成ではコスト効率が悪くなる可能性があります。そこで、**サーバレスアーキテクチャ**を採用し、以下のメリットを享受することになりました。

- サーバの管理が不要
- 使った分だけの従量課金でコスト最適化
- 自動的なスケーリング
- 高可用性の実現

あなたはインフラエンジニアとして、サーバレス構成で「メモアプリAPI」を構築する必要があります。

## 実施手順

1. まずは要件を実現するための設計として、AWS構成図を作成しましょう。
2. 構成図に従い、実際にAWSで環境構築してみましょう。
3. 構築が終わったら、動作確認をしていきましょう。

## 要件

### 要件1：APIエンドポイント
- REST APIとしてHTTPリクエストを受け付けるエンドポイントを作成する
- インターネットからアクセス可能にする

### 要件2：バックエンド処理
- サーバレスの関数でAPIのビジネスロジックを実行する
- 関数のランタイムはPythonを使用する
- サーバを管理することなく、リクエストに応じて自動的に実行される構成とする

### 要件3：データストア
- メモのデータを保存するためのNoSQLデータベースを使用する
- サーバレスで、使った分だけ課金されるデータベースを選定する

### 要件4：API仕様
以下のAPIを実装する

| メソッド | パス | 説明 |
| :--- | :--- | :--- |
| POST | /memos | 新しいメモを作成する |
| GET | /memos | すべてのメモを取得する |
| GET | /memos/{id} | 指定したIDのメモを取得する |
| PUT | /memos/{id} | 指定したIDのメモを更新する |
| DELETE | /memos/{id} | 指定したIDのメモを削除する |

#### メモのデータ構造
```json
{
  "id": "一意のID",
  "title": "メモのタイトル",
  "content": "メモの内容",
  "createdAt": "作成日時",
  "updatedAt": "更新日時"
}
```

## ヒント
- AWSにはサーバレスでAPIを構築するためのサービスが用意されています
- 関数のコードはAWSマネジメントコンソール上で直接編集することもできます
- NoSQLデータベースでは、パーティションキーの設計が重要です
- APIエンドポイントと関数の連携には、適切な統合設定が必要です

## 構築チェックリスト

下記が実装されていることを確認してください。

### 要件1：APIエンドポイント
- REST APIとしてHTTPリクエストを受け付けるエンドポイントが作成されていること
- インターネットからアクセス可能であること

### 要件2：バックエンド処理
- サーバレスの関数でAPIのビジネスロジックが実行されていること

### 要件3：データストア
- メモのデータを保存するためのNoSQLデータベースが使用されていること

## 動作確認
- POST /memos でメモが作成できること
    - 例：`curl -X POST https://<APIエンドポイント>/memos -H "Content-Type: application/json" -d '{"title": "買い物リスト", "content": "牛乳、卵、パン"}'`
- GET /memos ですべてのメモが取得できること
    - 例：`curl https://<APIエンドポイント>/memos`
- GET /memos/{id} で指定したIDのメモが取得できること
    - 例：`curl https://<APIエンドポイント>/memos/{id}`
- PUT /memos/{id} で指定したIDのメモが更新できること
    - 例：`curl -X PUT https://<APIエンドポイント>/memos/{id} -H "Content-Type: application/json" -d '{"title": "買い物リスト（更新）", "content": "牛乳、卵、パン、バター"}'`
- DELETE /memos/{id} で指定したIDのメモが削除できること
    - 例：`curl -X DELETE https://<APIエンドポイント>/memos/{id}`

## 理解度の確認
この課題の理解度を確認するため、以下の内容を言語化してみましょう。

### 問題1：サーバレスアーキテクチャのメリット
EC2などのサーバを使用した従来のアーキテクチャと比較して、Lambda + API Gateway + DynamoDBを使用したサーバレスアーキテクチャのメリット・デメリットを、「コスト」「スケーラビリティ」「運用」の観点から説明してください。

### 問題2：API GatewayとLambdaの連携
今回の構成において、クライアントからのHTTPリクエストがLambda関数で処理されるまでの流れを、API GatewayとLambdaの役割を明確にしながら説明してください。

### 問題3：DynamoDBの特徴
DynamoDBはNoSQLデータベースに分類されます。RDSなどのリレーショナルデータベースと比較した場合の特徴と、どのようなユースケースに適しているか説明してください。

## トラブルシューティング

### APIエンドポイントにアクセスできない
- API Gatewayのステージがデプロイされているか確認してください
- APIのリソースとメソッドが正しく設定されているか確認してください
- CORSの設定が必要な場合は、適切に設定されているか確認してください

### Lambda関数が実行されない
- API GatewayとLambda関数の統合が正しく設定されているか確認してください
- Lambda関数にAPI Gatewayからの呼び出し権限があるか確認してください
- CloudWatch Logsでエラーログを確認してください

### Lambda関数でエラーが発生する
- CloudWatch Logsで詳細なエラーメッセージを確認してください
- Lambda関数のタイムアウト設定が短すぎないか確認してください
- Lambda関数の実行ロールにDynamoDBへのアクセス権限があるか確認してください

### DynamoDBへのアクセスに失敗する
- テーブル名が正しいか確認してください
- パーティションキーの名前と型が正しいか確認してください
- Lambda関数のIAMロールにDynamoDBの操作権限（dynamodb:PutItem, dynamodb:GetItem, dynamodb:Scan, dynamodb:UpdateItem, dynamodb:DeleteItem）があるか確認してください

### APIレスポンスが正しく返らない
- Lambda関数の戻り値の形式が正しいか確認してください
- API Gatewayのレスポンス設定が正しいか確認してください

#### Lambda関数の戻り値の形式例
```python
{
    'statusCode': 200,
    'headers': {
        'Content-Type': 'application/json'
    },
    'body': json.dumps(response_data)
}
```

### データが保存されない
- DynamoDBテーブルが作成されているか確認してください
- Lambda関数内でDynamoDBへの書き込み処理が正しく実装されているか確認してください
- AWSマネジメントコンソールからDynamoDBテーブルの中身を確認してください
