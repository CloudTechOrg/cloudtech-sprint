# スプリント9：生成AI ハンズオン課題

## 背景

あなたは、とあるホテルを運営する企業で、インフラエンジニアとして働いています。

**生成AI**を活用し、ユーザーからの問い合わせに対して自動で回答を生成する仕組みを導入することにしました。また、ホテルの営業時間や住所などのプライベートな情報にも対応できるよう、**RAG（Retrieval-Augmented Generation）**の仕組みを使い、独自のデータを基に回答を生成する方式を採用します。

あなたはインフラエンジニアとして、上記の機能を構築する役割を担います。なお、今回はサーバレスの関数を活用したアプリケーションの開発も担当します。

## 実施手順

1. まずは要件を実現するための設計として、AWS構成図を作成しましょう。
2. 構成図に従い、実際にAWSで環境構築してみましょう。
3. 構築が終わったら、動作確認をしていきましょう。

## プロジェクト体制

| 担当 | チーム | 役割・タスク |
| :--- | :--- | :--- |
| **あなた** | インフラチーム | ・AWS構成図作成<br>・AWS環境構築<br>・関数コードの作成 |
| **メンター** | 支援チーム | ・成果物のレビュー<br>・技術サポート (CloudTech Academy受講生のみ) |

## 要件

### 要件1：RAGデータ
- ホテルの営業時間、住所、チェックイン・チェックアウト時間等の情報をまとめたファイルをストレージにアップロードし、RAGデータとして利用可能にする

### 要件2：生成AIの設定
- AWSの生成AIサービスを初期設定し、要件1のデータをRAGデータとして設定する

> 生成AIサービスの細かい設定は任意としますが、迷う場合は講座動画の設定を参考にしてください。

### 要件3：サーバレス関数
問い合わせの回答を自動生成し、問い合わせの種類を分類する機能として、サーバレス関数を作成する

#### 入力パラメータ
| パラメータ名 | 説明 |
| :--- | :--- |
| `inquiry_id` | 問い合わせのID |
| `inquiry_text` | 問い合わせ内容（テキスト） |

#### 処理内容
1. 受け取った問い合わせ内容（`inquiry_text`）を基に、生成AIを利用して回答を自動生成する
2. 受け取った問い合わせ内容を基に、生成AIを利用して問い合わせの種類を以下から分類する
   - 質問
   - 改善要望
   - ポジティブな感想
   - ネガティブな感想
   - その他

#### 出力
| パラメータ名 | 説明 |
| :--- | :--- |
| `inquiry_id` | 問い合わせのID（入力値をそのまま返却） |
| `answer` | 生成された回答 |
| `category` | 問い合わせの種類 |

## 動作確認

### 関数のテスト実行

関数のテストイベントに以下のJSONを設定して実行します。

#### テストイベント例1：質問
```json
{
  "inquiry_id": "INQ-001",
  "inquiry_text": "チェックインは何時からできますか？"
}
```

期待される出力例：
```json
{
  "inquiry_id": "INQ-001",
  "answer": "チェックインは15:00から可能です。アーリーチェックインをご希望の場合は、事前にお問い合わせください。",
  "category": "質問"
}
```

#### テストイベント例2：改善要望
```json
{
  "inquiry_id": "INQ-002",
  "inquiry_text": "Wi-Fiの速度が遅いので改善してほしいです"
}
```

期待される出力例：
```json
{
  "inquiry_id": "INQ-002",
  "answer": "Wi-Fiの速度についてご不便をおかけし申し訳ございません。現在、設備の改善を検討しております。貴重なご意見をいただきありがとうございます。",
  "category": "改善要望"
}
```

#### テストイベント例3：ポジティブな感想
```json
{
  "inquiry_id": "INQ-003",
  "inquiry_text": "スタッフの対応がとても良かったです！また利用したいです。"
}
```

期待される出力例：
```json
{
  "inquiry_id": "INQ-003",
  "answer": "嬉しいお言葉をいただきありがとうございます。スタッフ一同、大変励みになります。またのご利用を心よりお待ちしております。",
  "category": "ポジティブな感想"
}
```

## ヒント
- AWSには生成AIを利用するためのサービスが用意されています
- ナレッジベース機能を使うと、ストレージのデータをRAGとして利用できます
- 関数から生成AIを呼び出すには、boto3ライブラリを使用します
- 関数の実行ロールには、生成AIサービスとストレージへのアクセス権限が必要です
- 回答生成と分類は、それぞれ別のプロンプトで生成AIに問い合わせると良いでしょう

## トラブルシューティング

### Bedrockのモデルにアクセスできない
- Bedrockのモデルアクセスが有効になっているか確認してください
- AWSマネジメントコンソールのBedrockから「モデルアクセス」を開き、使用するモデルへのアクセスをリクエストしてください
- リージョンによって利用可能なモデルが異なります。東京リージョン（ap-northeast-1）で利用可能なモデルを確認してください

### Lambda関数からBedrockを呼び出せない
- Lambda関数の実行ロールに `bedrock:InvokeModel` 権限があるか確認してください
- ナレッジベースを使用する場合は `bedrock:Retrieve` 権限も必要です
- CloudWatch Logsでエラーログを確認してください

### RAGデータが反映されない
- S3バケットにファイルが正しくアップロードされているか確認してください
- Bedrockのナレッジベースでデータソースの同期が完了しているか確認してください
- ナレッジベースのステータスが「Available」になっているか確認してください

### Lambda関数がタイムアウトする
- Bedrockの呼び出しには時間がかかる場合があります
- Lambda関数のタイムアウト設定を延長してください（推奨：30秒以上）
- Lambda関数のメモリサイズを増やすと処理が高速化する場合があります

### 回答の品質が低い
- プロンプトの内容を見直してください
- RAGデータに必要な情報が含まれているか確認してください
- Bedrockのモデルパラメータ（temperature等）を調整してみてください

### Lambda関数のレスポンス形式
```python
import json

def lambda_handler(event, context):
    # 処理...

    return {
        'statusCode': 200,
        'body': json.dumps({
            'inquiry_id': event['inquiry_id'],
            'answer': generated_answer,
            'category': classified_category
        }, ensure_ascii=False)
    }
```
