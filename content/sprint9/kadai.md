# スプリント9：生成AI ハンズオン課題

## 背景

あなたは、とあるホテルを運営する企業で、インフラエンジニアとして働いています。

**生成AI**を活用し、ユーザーからの問い合わせに対して自動で回答を生成する仕組みを導入することにしました。また、ホテルの営業時間や住所などのプライベートな情報にも対応できるよう、**RAG（Retrieval-Augmented Generation）**の仕組みを使い、独自のデータを基に回答を生成する方式を採用します。

あなたはインフラエンジニアとして、上記の機能を構築する役割を担います。なお、今回はサーバレスの関数を活用したアプリケーションの開発も担当します。

## 実施手順

1. まずは要件を実現するための設計として、AWS構成図を作成しましょう。
2. 構成図に従い、実際にAWSで環境構築してみましょう。
3. 構築が終わったら、動作確認をしていきましょう。

## 要件

### 要件1：RAGデータ
- ホテルの営業時間、住所、チェックイン・チェックアウト時間等の情報をまとめたファイルをストレージにアップロードし、RAGデータとして利用可能にする

### 要件2：生成AIの設定
- AWSの生成AIサービスを初期設定し、要件1のデータをRAGデータとして設定する

> 生成AIサービスの細かい設定は任意としますが、迷う場合は講座動画の設定を参考にしてください。

### 要件3：サーバレス関数
問い合わせの回答を自動生成し、問い合わせの種類を分類する機能として、サーバレス関数を作成する

#### 入力パラメータ
| パラメータ名 | 説明 |
| :--- | :--- |
| `inquiry_id` | 問い合わせのID |
| `inquiry_text` | 問い合わせ内容（テキスト） |

#### 処理内容
1. 受け取った問い合わせ内容（`inquiry_text`）を基に、生成AIを利用して回答を自動生成する
2. 受け取った問い合わせ内容を基に、生成AIを利用して問い合わせの種類を以下から分類する
   - 質問
   - 改善要望
   - ポジティブな感想
   - ネガティブな感想
   - その他

#### 出力
| パラメータ名 | 説明 |
| :--- | :--- |
| `inquiry_id` | 問い合わせのID（入力値をそのまま返却） |
| `answer` | 生成された回答 |
| `category` | 問い合わせの種類 |

## 構築チェックリスト

下記が実装されていることを確認してください。

### 要件1：RAGデータ
- ホテルの情報（営業時間、住所、チェックイン・チェックアウト時間等）がファイルとしてストレージにアップロードされていること
- RAGデータとして利用可能な状態になっていること

### 要件2：生成AIの設定
- 生成AIサービスが初期設定されていること
- RAGデータが生成AIに設定されていること

### 要件3：サーバレス関数
- 問い合わせの回答を自動生成する関数が作成されていること
- 問い合わせの種類を分類する機能が実装されていること
- 入力パラメータ（`inquiry_id`, `inquiry_text`）を正しく受け取ること
- 出力パラメータ（`inquiry_id`, `answer`, `category`）を正しく返却すること
- 問い合わせの種類が「質問」「改善要望」「ポジティブな感想」「ネガティブな感想」「その他」のいずれかに分類されること

## 動作確認
- 関数のテストイベントを実行し、問い合わせに対する回答が自動生成されること
    - テストイベント例：`{"inquiry_id": "INQ-001", "inquiry_text": "チェックインは何時からできますか？"}`
    - 出力例：`{"inquiry_id": "INQ-001", "answer": "チェックインは15:00から可能です。...", "category": "質問"}`
- 問い合わせの種類が正しく分類されること（質問、改善要望、ポジティブな感想、ネガティブな感想、その他）

## 理解度の確認
この課題の理解度を確認するため、以下の内容を言語化してみましょう。

### 問題1：RAG（検索拡張生成）の仕組み
RAG（Retrieval-Augmented Generation）とは何か、その仕組みと、生成AIを単体で使用する場合と比較したメリットについて説明してください。

### 問題2：Amazon Bedrockの特徴
Amazon Bedrockとは何か、その特徴と、生成AIをアプリケーションに組み込む際にBedrockを利用するメリットについて説明してください。

### 問題3：プロンプトエンジニアリング
生成AIから期待する出力を得るために、プロンプト（指示文）の書き方が重要です。効果的なプロンプトを作成するためのポイントや工夫について、具体例を交えて説明してください。

### 問題4：生成AI活用時の注意点
業務システムで生成AIを活用する際に注意すべき点について、「ハルシネーション（誤った情報の生成）」「セキュリティ・プライバシー」「コスト」の観点から説明してください。

## ヒント
- AWSには生成AIを利用するためのサービスが用意されています
- ナレッジベース機能を使うと、ストレージのデータをRAGとして利用できます
- 関数から生成AIを呼び出すには、boto3ライブラリを使用します
- 関数の実行ロールには、生成AIサービスとストレージへのアクセス権限が必要です
- 回答生成と分類は、それぞれ別のプロンプトで生成AIに問い合わせると良いでしょう

## トラブルシューティング

### Bedrockのモデルにアクセスできない
- Bedrockのモデルアクセスが有効になっているか確認してください
- AWSマネジメントコンソールのBedrockから「モデルアクセス」を開き、使用するモデルへのアクセスをリクエストしてください
- リージョンによって利用可能なモデルが異なります。東京リージョン（ap-northeast-1）で利用可能なモデルを確認してください

### Lambda関数からBedrockを呼び出せない
- Lambda関数の実行ロールに `bedrock:InvokeModel` 権限があるか確認してください
- ナレッジベースを使用する場合は `bedrock:Retrieve` 権限も必要です
- CloudWatch Logsでエラーログを確認してください

### RAGデータが反映されない
- S3バケットにファイルが正しくアップロードされているか確認してください
- Bedrockのナレッジベースでデータソースの同期が完了しているか確認してください
- ナレッジベースのステータスが「Available」になっているか確認してください

### Lambda関数がタイムアウトする
- Bedrockの呼び出しには時間がかかる場合があります
- Lambda関数のタイムアウト設定を延長してください（推奨：30秒以上）
- Lambda関数のメモリサイズを増やすと処理が高速化する場合があります

### 回答の品質が低い
- プロンプトの内容を見直してください
- RAGデータに必要な情報が含まれているか確認してください
- Bedrockのモデルパラメータ（temperature等）を調整してみてください

### Lambda関数のレスポンス形式
```python
import json

def lambda_handler(event, context):
    # 処理...

    return {
        'statusCode': 200,
        'body': json.dumps({
            'inquiry_id': event['inquiry_id'],
            'answer': generated_answer,
            'category': classified_category
        }, ensure_ascii=False)
    }
```
