# スプリント12：マルチアカウント ハンズオン課題

## 背景

これまでは、1つのAWSアカウントで環境構築を行ってきました。しかし、今後は複数のシステムを開発していく計画があり、システムごとにアカウントを分けていく方針です。そのためには、複数のアカウントを管理するための仕組みを構築する必要があります。

具体的には、管理用アカウントを作成し、**AWS Organizationsの組織単位（Organizational Unit、以降OU）** において既存アカウント（開発アカウント）を管理します。

開発用のOUには、AWS CloudTrailを無効化・削除できないようにする**サービスコントロールポリシー（Service Control Policy）** を設定し、ガバナンスを強化します。

あなたはインフラエンジニアとして、上記要件を満たす環境を構築する必要があります。

## 実施手順

1. まずは要件を実現するための設計として、AWS構成図を作成しましょう。
2. 構成図に従い、実際にAWSで環境構築してみましょう。
3. 構築が終わったら、動作確認をしていきましょう。

## 要件

### 要件1：管理者アカウントの作成
- 新しくAWSアカウントを作成し、「管理者アカウント」と定義する
- 既存のアカウントは「開発アカウント」と定義する（特に操作不要）

### 要件2：AWS Organizations
- 管理者アカウントをOrganizationsの「管理アカウント」として設定する
- OU（組織単位）として「システム環境」を作成し、「開発アカウント」を所属させる

### 要件3：SCPの設定
- OUに「CloudTrailの停止・削除」を禁止するSCPを適用し、有効化状態を維持させる

### 要件4：S3バケットの作成
- 「管理アカウント」に、CloudTrailのログを受け取るS3バケットを作成
- 「開発アカウント」からデータを書き込めるように、バケットポリシーを設定する

### 要件5：CloudTrail
- 「開発アカウント」にて、CloudTrailを有効化し、ログを要件4のS3バケットに出力する

### 要件6：IAMロール
- 管理アカウントにIAMロールを作成し、要件4のS3バケットを参照できるポリシーをアタッチする
- 開発アカウントからAssumeRoleを使ってこのロールを引き受け、S3バケットを参照できるように設定

## 提出物

下記が実装されていることがわかるスクリーンショットを提出してください。

### 要件1：管理者アカウントの作成
- 新しくAWSアカウント（管理者アカウント）が作成されていること
- 既存のアカウントが開発アカウントとして定義されていること

### 要件2：AWS Organizations
- 管理者アカウントがOrganizationsの「管理アカウント」として設定されていること
- OU（組織単位）として「システム環境」が作成されていること
- 開発アカウントが「システム環境」OUに所属していること

### 要件3：SCPの設定
- CloudTrailの停止・削除を禁止するSCPがOUに適用されていること
- 開発アカウントでCloudTrailの停止・削除が拒否されること

### 要件4：S3バケットの作成
- 管理アカウントにCloudTrailのログを受け取るS3バケットが作成されていること
- 開発アカウントからデータを書き込めるバケットポリシーが設定されていること

### 要件5：CloudTrail
- 開発アカウントでCloudTrailが有効化されていること
- ログが管理アカウントのS3バケットに出力されること

### 要件6：IAMロール
- 管理アカウントにIAMロールが作成されていること
- S3バケットを参照できるポリシーがアタッチされていること
- 開発アカウントからAssumeRoleでこのロールを引き受けられること
- 開発アカウントからS3バケットを参照できること

## 動作確認

### 1. SCPの動作確認
開発アカウントでCloudTrailの停止・削除が禁止されていることを確認します。

1. 開発アカウントにログイン
2. CloudTrailのコンソールを開く
3. 証跡の停止または削除を試みる
4. SCPにより操作が拒否されることを確認

### 2. CloudTrailログの確認
開発アカウントの操作ログが管理アカウントのS3バケットに保存されていることを確認します。

1. 開発アカウントで何らかの操作を行う（例：EC2インスタンスの一覧表示）
2. 管理アカウントのS3バケットを確認
3. 開発アカウントのCloudTrailログが保存されていることを確認

### 3. クロスアカウントアクセスの確認
開発アカウントからAssumeRoleを使用して、管理アカウントのS3バケットにアクセスできることを確認します。

```bash
# 開発アカウントでAssumeRoleを実行
aws sts assume-role \
  --role-arn arn:aws:iam::<管理アカウントID>:role/<ロール名> \
  --role-session-name test-session

# 取得した一時認証情報を使用してS3バケットの内容を確認
aws s3 ls s3://<バケット名>/ --profile <プロファイル名>
```

## ヒント

- AWSには複数のアカウントを一元管理するためのサービスがあります
- 組織単位（OU）を使用すると、複数のアカウントをグループ化して管理できます
- サービスコントロールポリシー（SCP）は、組織全体またはOU単位で適用できます
- クロスアカウントでS3にアクセスするには、バケットポリシーとIAMロールの両方の設定が必要です
- AssumeRoleを使用すると、別のアカウントのロールを引き受けて操作できます

## トラブルシューティング

### Organizationsでアカウントを招待できない
- 管理アカウントでOrganizationsが正しく有効化されているか確認してください
- 招待先のアカウントのメールアドレスが正しいか確認してください
- 招待先アカウントで招待を承認する必要があります

### SCPが適用されない
- SCPがOUまたはアカウントに正しくアタッチされているか確認してください
- SCPのJSON構文が正しいか確認してください
- 管理アカウント自体にはSCPは適用されません（管理アカウントは常にフルアクセス）

### SCPのサンプル（CloudTrail保護）
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "ProtectCloudTrail",
      "Effect": "Deny",
      "Action": [
        "cloudtrail:DeleteTrail",
        "cloudtrail:StopLogging",
        "cloudtrail:UpdateTrail"
      ],
      "Resource": "*"
    }
  ]
}
```

### CloudTrailのログがS3に保存されない
- CloudTrailの証跡が正しく作成されているか確認してください
- S3バケットポリシーでCloudTrailからの書き込みが許可されているか確認してください
- S3バケットが存在するリージョンとCloudTrailのリージョンを確認してください

### S3バケットポリシーのサンプル（クロスアカウント用）
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowCloudTrailWrite",
      "Effect": "Allow",
      "Principal": {
        "Service": "cloudtrail.amazonaws.com"
      },
      "Action": "s3:PutObject",
      "Resource": "arn:aws:s3:::<バケット名>/AWSLogs/<開発アカウントID>/*",
      "Condition": {
        "StringEquals": {
          "s3:x-amz-acl": "bucket-owner-full-control"
        }
      }
    },
    {
      "Sid": "AllowCloudTrailBucketACL",
      "Effect": "Allow",
      "Principal": {
        "Service": "cloudtrail.amazonaws.com"
      },
      "Action": "s3:GetBucketAcl",
      "Resource": "arn:aws:s3:::<バケット名>"
    }
  ]
}
```

### AssumeRoleが失敗する
- IAMロールの信頼ポリシーで、開発アカウントからのAssumeRoleが許可されているか確認してください
- 開発アカウントのIAMユーザー/ロールに `sts:AssumeRole` 権限があるか確認してください
- ロールのARNが正しいか確認してください

### IAMロールの信頼ポリシーのサンプル
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::<開発アカウントID>:root"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}
```

### OUにアカウントを移動できない
- アカウントがOrganizationsのメンバーになっているか確認してください
- 移動先のOUが存在するか確認してください
- 管理アカウントでの操作権限があるか確認してください

### 複数アカウントの切り替えが面倒
- AWS CLIのプロファイル機能を使用すると、複数アカウントを簡単に切り替えられます
- `~/.aws/credentials` にプロファイルを設定してください
- IAM Identity Center（旧AWS SSO）を使用すると、より便利にアカウントを切り替えられます
