# スプリント5：コンテナ＆オートスケーリング ハンズオン課題

## 背景

あなたは、とあるWebサービスを運営する企業で、インフラエンジニアとして働いています。

この度、新しく自社サービスとして「名簿管理API」をリリースすることになりました。
（Sprint2で作成したものと同様の内容です）

すでにアプリケーション開発チームがAPIの開発を完了しています。APIのデータを保存するためのDBサーバはインフラエンジニアであるあなたが構築する必要があります。

また、この環境は**コンテナにて動作**させたうえで、**ロードバランサーによる負荷分散**と**オートスケーリングによる自動スケーリング**を実現する必要があります。

あなたはインフラエンジニアとして、これらのアプリケーションが正常に動作するインフラ環境を構築する必要があります。

## 実施手順

1. まずは要件を実現するための設計として、AWS構成図を作成しましょう。
2. 構成図に従い、実際にAWSで環境構築してみましょう。
3. 構築が終わったら、動作確認をしていきましょう。

## 要件

### 要件1：コンテナ基盤
- GoのAPIをコンテナとして動作させる
- コンテナイメージを保存するためのレジストリを用意する
- コンテナを実行するための適切なAWSサービスを選定する

#### コンテナイメージについて
- コンテナイメージは [こちら](https://github.com/CloudTechOrg/sprint5-api) のDockerfileを使用してビルドしてください
- ビルドしたイメージをレジストリにプッシュして使用します

### 要件2：環境変数の設定
- コンテナに以下の環境変数を設定する
- これらの環境変数により、コンテナからRDSへ接続できるようになる

| 環境変数名 | 設定値 |
| :--- | :--- |
| `DB_HOST` | RDSのエンドポイント |
| `DB_USER` | RDSのマスターユーザー名 |
| `DB_PASSWORD` | RDSのマスターパスワード |
| `DB_NAME` | `meibo` |

### 要件3：ロードバランサー
- ロードバランサーを使用して、複数のコンテナへの負荷分散を行う
- ロードバランサーはインターネットからのHTTP（80ポート）リクエストを受け付ける
- ヘルスチェックを設定し、正常なコンテナにのみトラフィックを振り分ける

### 要件4：オートスケーリング
- 負荷に応じてコンテナの数を自動的にスケーリングする
- 以下の条件でスケーリングを行う
  - 最小コンテナ数：2
  - 最大コンテナ数：4
  - スケーリング条件：CPU使用率が70%を超えたらスケールアウト

### 要件5：DBサーバ
- DBサーバとしてRDSインスタンスを構成する
- RDSのDBエンジンはMySQLを使用する
- データベース名は `meibo` とする
- 構成については、無料利用枠の範囲とする

### 要件6：ネットワーク構成
- VPC内に適切なサブネットを構成する
  - ロードバランサー用のサブネット
  - コンテナ・RDS用のサブネット
- コンテナがインターネットからイメージをプルできるようにする

## 提出物

下記が実装されていることがわかるスクリーンショットを提出してください。

### 要件1：コンテナ基盤
- GoのAPIがコンテナとして動作していること
- コンテナイメージを保存するためのレジストリが用意されていること

### 要件2：環境変数の設定
- 環境変数に`DB_HOST`が設定されていること
- 環境変数に`DB_USER`が設定されていること
- 環境変数に`DB_PASSWORD`が設定されていること
- 環境変数に`DB_NAME`が `meibo` で設定されていること

### 要件3：ロードバランサー
- ロードバランサーが作成されていること
- 複数のコンテナへの負荷分散が行われていること
- インターネットからの80ポート（HTTP）リクエストを受け付けていること
- ヘルスチェックが設定されていること

### 要件4：オートスケーリング
- 負荷に応じたオートスケーリングが設定されていること
- 最小コンテナ数が2、最大コンテナ数が4であること
- CPU使用率70%でスケールアウトすること

### 要件5：DBサーバ
- RDSインスタンスが作成されていること
- DBエンジンはMySQLが使用されていること

### 要件6：ネットワーク構成
- VPC内にロードバランサー用のサブネットが構成されていること
- VPC内にコンテナ・RDS用のサブネットが構成されていること
- コンテナがインターネットからイメージをプルできること

## 動作確認
- ロードバランサーのDNS名でAPIにアクセスし、正常に動作すること
    - 例：`curl http://<ロードバランサーのDNS名>/users`
- コンテナからRDSへの接続が正常に行われること

## APIの使い方
- [こちら](https://github.com/CloudTechOrg/sprint5-api/blob/main/README.md)に、APIの操作方法が記載されています
- ロードバランサーのDNS名を使用してAPIにアクセスします

## ヒント
- コンテナのリソースサイズは、vCPU: 0.25、メモリ: 0.5GBから始めると良いでしょう。
- RDSのインスタンスクラスは `db.t3.micro` または `db.t4g.micro` を使用すると、無料利用枠の対象となります。
- レジストリへのイメージプッシュは、AWS CLIを使用して行います。
- ロードバランサーのヘルスチェックパスは `/health` または `/` を設定してください。

## トラブルシューティング

### ALBからAPIにアクセスできない
- ターゲットグループのヘルスチェックが成功しているか確認してください
- ECSタスクのセキュリティグループで、ALBからの通信が許可されているか確認してください
- ECSタスクが正常に起動しているか、CloudWatch Logsでコンテナログを確認してください

### ECSタスクが起動しない
- タスク定義の設定（CPU、メモリ、コンテナイメージURL）が正しいか確認してください
- ECRにイメージが正しくプッシュされているか確認してください
- タスク実行ロールにECRからのイメージプル権限があるか確認してください
- CloudWatch Logsでエラーログを確認してください

### ECSタスクがコンテナイメージの取得に失敗する
- ECSタスクがプライベートサブネットに配置されている場合、NAT Gatewayが存在するか確認してください
- NAT Gatewayがパブリックサブネットに配置されているか確認してください
- プライベートサブネットのルートテーブルに、NAT Gatewayへのルート（0.0.0.0/0）が設定されているか確認してください
- NAT GatewayにElastic IPが割り当てられているか確認してください

### コンテナからDBへの接続ができない
- タスク定義の環境変数（DB_HOST, DB_USER, DB_PASSWORD, DB_NAME）が正しく設定されているか確認してください
- RDSのセキュリティグループで、ECSタスクからの3306ポート通信が許可されているか確認してください
- ECSタスクがRDSと同じVPC内のプライベートサブネットに配置されているか確認してください

### オートスケーリングが動作しない
- ECSサービスのAuto Scaling設定が有効になっているか確認してください
- CloudWatchアラームが正しく設定されているか確認してください
- スケーリングポリシーのしきい値（CPU使用率70%）が適切か確認してください

### コンテナイメージのプッシュに失敗する
- AWS CLIでECRにログインしているか確認してください
- ECRリポジトリが作成されているか確認してください
- IAMユーザーにECRへのプッシュ権限があるか確認してください

```bash
# ECRログインコマンド例
aws ecr get-login-password --region ap-northeast-1 | docker login --username AWS --password-stdin <アカウントID>.dkr.ecr.ap-northeast-1.amazonaws.com
```

### RDSに正しくデータが作成されていない
RDSに直接接続してデータを確認したい場合は、踏み台サーバを作成してアクセスする方法があります。

#### 踏み台サーバの作成
- EC2インスタンス（Amazon Linux 2023）を作成する
- RDSと同じVPC内に配置する
- RDSのセキュリティグループで、踏み台サーバからの3306ポート通信を許可する

#### 踏み台サーバからRDSへ接続する方法
踏み台サーバにSSH接続後、以下の手順でMySQLクライアントをインストールし、RDSへ接続します。

```bash
# MySQLクライアントのインストール
sudo dnf install -y mariadb105

# RDSへ接続
mysql -h <RDSのエンドポイント> -u <マスターユーザー名> -p

# データベースとテーブルを確認
USE meibo;
SHOW TABLES;
SELECT * FROM users;
```
